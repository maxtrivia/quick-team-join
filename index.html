<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quick Team Join</title>
<style>
  :root {
    font-family: "Trebuchet MS", "Segoe UI", system-ui, sans-serif;
    color-scheme: dark;
  }
  body {
    margin: 0;
    background-color: #0d0d0d;
    color: #e0e0e0;
    background-image: radial-gradient(circle at 50% 0%, #1a1a1a, #000);
    min-height: 100vh;
    padding: 24px;
  }
  h1, h3 {
    color: #ffcc00;
    text-shadow: 0 0 8px #ff6600;
  }
  a { color: #66ccff; }
  .card {
    background: rgba(20, 20, 20, 0.9);
    border: 1px solid #333;
    border-radius: 10px;
    padding: 24px;
    max-width: 760px;
    margin: auto;
    box-shadow: 0 0 12px rgba(255, 255, 255, 0.05);
  }
  input, button {
    padding: 10px 12px;
    border-radius: 8px;
    border: 1px solid #555;
    background: #1c1c1c;
    color: #eee;
  }
  button {
    background: linear-gradient(180deg, #333 0%, #111 100%);
    cursor: pointer;
  }
  button:hover { background: linear-gradient(180deg, #444 0%, #222 100%); }
  .teams {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-top: 16px;
  }
  .team {
    border: 1px solid #333;
    border-radius: 8px;
    padding: 10px;
    background: rgba(0, 0, 0, 0.4);
  }
  .muted { color: #999; }
  .linkbox {
    background: rgba(40, 40, 40, 0.9);
    padding: 10px;
    border-radius: 8px;
    word-break: break-all;
  }
</style>


  <!-- Firebase (modular) -->
  <script type="module">
    // --- 1) Replace with your Firebase config from the Firebase console ---
    const firebaseConfig = {
     apiKey: "AIzaSyDqK370QK56_Fvm2lJH5zEVox-aFhi_eo0",
  authDomain: "trivia-team-generator.firebaseapp.com",
  databaseURL: "https://trivia-team-generator-default-rtdb.firebaseio.com",
  projectId: "trivia-team-generator",
  storageBucket: "trivia-team-generator.firebasestorage.app",
  messagingSenderId: "832962439903",
  appId: "1:832962439903:web:503349a103ecd18d5d576a",
  measurementId: "G-VBLS86G74D"
    };
    // ---------------------------------------------------------------------

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
      getDatabase, ref, onValue, runTransaction, set, push, remove, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // Utilities
    const $ = (sel) => document.querySelector(sel);
    const roomParam = new URLSearchParams(location.search).get("room") || "";

    function randomCode(len = 6) {
      const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789"; // no ambiguous chars
      let out = "";
      for (let i = 0; i < len; i++) out += chars[Math.floor(Math.random() * chars.length)];
      return out;
    }

    // UI elements
    const createBtn = document.getElementById("create-room");
    const joinBtn   = document.getElementById("join-btn");
    const nameInput = document.getElementById("name");
    const roomInput = document.getElementById("room");
    const shareBox  = document.getElementById("share");
    const roster    = document.getElementById("roster");
    const resetBtn  = document.getElementById("reset-room");
    const statusEl  = document.getElementById("status");

    // Initialize room field with URL param if present
    if (roomParam) roomInput.value = roomParam;

    // Create room
    createBtn.addEventListener("click", async () => {
      const code = randomCode();
      const roomRef = ref(db, `rooms/${code}`);
      await set(roomRef, {
        createdAt: Date.now(),
        teams: 3,
        counts: { "1": 0, "2": 0, "3": 0 }
      });
      const link = `${location.origin}${location.pathname}?room=${code}`;
      shareBox.innerHTML = `
        <div class="linkbox"><strong>Room:</strong> ${code}<br><strong>Link:</strong> <a href="${link}">${link}</a></div>
        <div class="muted">Share this link. Anyone who opens it can join & will be auto-assigned.</div>
      `;
      roomInput.value = code;
      attachRoomListeners(code);
      status("Room created.");
    });

    // Join -> auto-assign (balanced by smallest team)
    joinBtn.addEventListener("click", async () => {
      const name = nameInput.value.trim();
      const code = roomInput.value.trim().toUpperCase();
      if (!code) return status("Enter a room code or create a room.", true);
      if (!name) return status("Enter a nickname.", true);

      const roomRef = ref(db, `rooms/${code}`);
      // Transaction to safely pick a team and bump the count atomically
      const txResult = await runTransaction(roomRef, (room) => {
        if (room === null) {
          // Room doesnâ€™t exist, abort
          return room;
        }
        if (!room.counts) room.counts = { "1": 0, "2": 0, "3": 0 };
        // Pick team with smallest count (balanced). If tie, pick lowest index.
        const counts = room.counts;
        const entries = [["1", counts["1"] || 0], ["2", counts["2"] || 0], ["3", counts["3"] || 0]];
        entries.sort((a,b) => a[1] - b[1]); // ascending by count
        const chosen = entries[0][0];
        room.counts[chosen] = (room.counts[chosen] || 0) + 1;
        // Return updated room to commit
        return room;
      });

      if (!txResult.committed || !txResult.snapshot.exists()) {
        return status("Room not found. Create it first or check the code.", true);
      }

      // After count is incremented, add the member record (non-critical if it races)
      const chosenTeam = pickSmallestFromCounts(txResult.snapshot.val().counts);
      const membersRef = ref(db, `rooms/${code}/members`);
      await push(membersRef, {
        name,
        team: chosenTeam,
        joinedAt: serverTimestamp()
      });

      status(`You joined Team ${chosenTeam}!`);
    });

    // Compute smallest team (same logic used for display confirmation)
    function pickSmallestFromCounts(counts) {
      const entries = [["1", counts["1"] || 0], ["2", counts["2"] || 0], ["3", counts["3"] || 0]];
      entries.sort((a,b) => a[1] - b[1]);
      return entries[0][0];
    }

    // Reset room (clear members & counts)
    resetBtn.addEventListener("click", async () => {
      const code = roomInput.value.trim().toUpperCase();
      if (!code) return status("Enter a room code first.", true);
      if (!confirm("Reset this room? This clears all members & counts.")) return;
      await set(ref(db, `rooms/${code}/counts`), { "1": 0, "2": 0, "3": 0 });
      await remove(ref(db, `rooms/${code}/members`));
      status("Room reset.");
    });

    // Live listeners for roster
    function attachRoomListeners(code) {
      // counts
      onValue(ref(db, `rooms/${code}/counts`), (snap) => {
        const counts = snap.val() || { "1": 0, "2": 0, "3": 0 };
        $("#c1").textContent = counts["1"] || 0;
        $("#c2").textContent = counts["2"] || 0;
        $("#c3").textContent = counts["3"] || 0;
      });
      // members
      onValue(ref(db, `rooms/${code}/members`), (snap) => {
        const byTeam = { "1": [], "2": [], "3": [] };
        const data = snap.val() || {};
        Object.values(data).forEach(m => {
          if (m && m.team && byTeam[m.team]) byTeam[m.team].push(m.name || "â€”");
        });
        ["1","2","3"].forEach(t => {
          const ul = document.getElementById(`t${t}`);
          ul.innerHTML = (byTeam[t].length ? byTeam[t] : []).map(n => `<li>${escapeHtml(n)}</li>`).join("");
        });
      });
    }

    function status(msg, isError=false) {
      statusEl.textContent = msg;
      statusEl.style.color = isError ? "crimson" : "inherit";
    }

    function escapeHtml(s) {
      return (s || "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]));
    }

    // Auto-attach listeners if URL had ?room=CODE
    if (roomParam) attachRoomListeners(roomParam.toUpperCase());
  </script>
</head>
<body>
  <div class="card">
    <h1>âš“ï¸ Swift Crew Joininâ€™! â˜ ï¸</h1>
    <p>
  Ahoy, ye salty dogs! ğŸ´â€â˜ ï¸<br>
  Scrawl yer name below, and our clever sea-sorcerinâ€™ contraption shall cast ye into a crew oâ€™ trivia buccaneers.<br>
  No bribinâ€™, no cheatinâ€™â€”itâ€™ll be fair as the tide herself!<br>
  The gods of the deep shall decide yer fateâ€¦ so hope they be in a merry mood! âš“ï¸ğŸ’€
</p>


    <h3>1) â˜ ï¸ Start a New Room or Join One!</h3>
    <div class="row">
      <button id="create-room">Create new room</button>
      <input id="room" placeholder="Secret Ship Code (fer example: ABC123)" />
      <button id="reset-room" title="Clear members & counts for this room">Reset</button>
    </div>
    <div id="share" style="margin-top:10px;"></div>

    <h3 style="margin-top:24px;">2) Hop Aboard</h3>
    <div class="row">
      <input id="name" placeholder="Yer Pirate Name" />
      <button id="join-btn">Be Cast by the Fates! âš“ï¸</button>
    </div>
    <div id="status" style="margin-top:10px;"></div>

    <h3 style="margin-top:24px;">ğŸ’€ Ships Currently at Sea</h3>
    <div class="teams" id="roster">
      <div class="team">
        <strong>The Drunken Barnacles ğŸºğŸ¦ª</strong> â€” <span id="c1">0</span>
        <ul id="t1" style="margin:8px 0 0 18px;"></ul>
      </div>
      <div class="team">
        <strong>The Booty Hunters ğŸ‘ğŸ’°</strong> â€” <span id="c2">0</span>
        <ul id="t2" style="margin:8px 0 0 18px;"></ul>
      </div>
      <div class="team">
        <strong>The Salty Parrots ğŸ¦œ</strong> â€” <span id="c3">0</span>
        <ul id="t3" style="margin:8px 0 0 18px;"></ul>
      </div>
    </div>
  </div>
</body>
</html>


