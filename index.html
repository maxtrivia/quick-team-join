<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quick Team Join</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    body { margin: 24px; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 16px; max-width: 720px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    input, button { padding: 10px 12px; border-radius: 8px; border: 1px solid #ccc; }
    button { cursor: pointer; }
    .teams { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 16px; }
    .team { border: 1px solid #eee; border-radius: 8px; padding: 10px; }
    .muted { color: #666; }
    .linkbox { background: #f8f8f8; padding: 10px; border-radius: 8px; word-break: break-all; }
  </style>

  <!-- Firebase (modular) -->
  <script type="module">
    // --- 1) Replace with your Firebase config from the Firebase console ---
    const firebaseConfig = {
     apiKey: "AIzaSyDqK370QK56_Fvm2lJH5zEVox-aFhi_eo0",
  authDomain: "trivia-team-generator.firebaseapp.com",
  databaseURL: "https://trivia-team-generator-default-rtdb.firebaseio.com",
  projectId: "trivia-team-generator",
  storageBucket: "trivia-team-generator.firebasestorage.app",
  messagingSenderId: "832962439903",
  appId: "1:832962439903:web:503349a103ecd18d5d576a",
  measurementId: "G-VBLS86G74D"
    };
    // ---------------------------------------------------------------------

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
      getDatabase, ref, onValue, runTransaction, set, push, remove, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // Utilities
    const $ = (sel) => document.querySelector(sel);
    const roomParam = new URLSearchParams(location.search).get("room") || "";

    function randomCode(len = 6) {
      const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789"; // no ambiguous chars
      let out = "";
      for (let i = 0; i < len; i++) out += chars[Math.floor(Math.random() * chars.length)];
      return out;
    }

    // UI elements
    const createBtn = document.getElementById("create-room");
    const joinBtn   = document.getElementById("join-btn");
    const nameInput = document.getElementById("name");
    const roomInput = document.getElementById("room");
    const shareBox  = document.getElementById("share");
    const roster    = document.getElementById("roster");
    const resetBtn  = document.getElementById("reset-room");
    const statusEl  = document.getElementById("status");

    // Initialize room field with URL param if present
    if (roomParam) roomInput.value = roomParam;

    // Create room
    createBtn.addEventListener("click", async () => {
      const code = randomCode();
      const roomRef = ref(db, `rooms/${code}`);
      await set(roomRef, {
        createdAt: Date.now(),
        teams: 3,
        counts: { "1": 0, "2": 0, "3": 0 }
      });
      const link = `${location.origin}${location.pathname}?room=${code}`;
      shareBox.innerHTML = `
        <div class="linkbox"><strong>Room:</strong> ${code}<br><strong>Link:</strong> <a href="${link}">${link}</a></div>
        <div class="muted">Share this link. Anyone who opens it can join & will be auto-assigned.</div>
      `;
      roomInput.value = code;
      attachRoomListeners(code);
      status("Room created.");
    });

    // Join -> auto-assign (balanced by smallest team)
    joinBtn.addEventListener("click", async () => {
      const name = nameInput.value.trim();
      const code = roomInput.value.trim().toUpperCase();
      if (!code) return status("Enter a room code or create a room.", true);
      if (!name) return status("Enter a nickname.", true);

      const roomRef = ref(db, `rooms/${code}`);
      // Transaction to safely pick a team and bump the count atomically
      const txResult = await runTransaction(roomRef, (room) => {
        if (room === null) {
          // Room doesn’t exist, abort
          return room;
        }
        if (!room.counts) room.counts = { "1": 0, "2": 0, "3": 0 };
        // Pick team with smallest count (balanced). If tie, pick lowest index.
        const counts = room.counts;
        const entries = [["1", counts["1"] || 0], ["2", counts["2"] || 0], ["3", counts["3"] || 0]];
        entries.sort((a,b) => a[1] - b[1]); // ascending by count
        const chosen = entries[0][0];
        room.counts[chosen] = (room.counts[chosen] || 0) + 1;
        // Return updated room to commit
        return room;
      });

      if (!txResult.committed || !txResult.snapshot.exists()) {
        return status("Room not found. Create it first or check the code.", true);
      }

      // After count is incremented, add the member record (non-critical if it races)
      const chosenTeam = pickSmallestFromCounts(txResult.snapshot.val().counts);
      const membersRef = ref(db, `rooms/${code}/members`);
      await push(membersRef, {
        name,
        team: chosenTeam,
        joinedAt: serverTimestamp()
      });

      status(`You joined Team ${chosenTeam}!`);
    });

    // Compute smallest team (same logic used for display confirmation)
    function pickSmallestFromCounts(counts) {
      const entries = [["1", counts["1"] || 0], ["2", counts["2"] || 0], ["3", counts["3"] || 0]];
      entries.sort((a,b) => a[1] - b[1]);
      return entries[0][0];
    }

    // Reset room (clear members & counts)
    resetBtn.addEventListener("click", async () => {
      const code = roomInput.value.trim().toUpperCase();
      if (!code) return status("Enter a room code first.", true);
      if (!confirm("Reset this room? This clears all members & counts.")) return;
      await set(ref(db, `rooms/${code}/counts`), { "1": 0, "2": 0, "3": 0 });
      await remove(ref(db, `rooms/${code}/members`));
      status("Room reset.");
    });

    // Live listeners for roster
    function attachRoomListeners(code) {
      // counts
      onValue(ref(db, `rooms/${code}/counts`), (snap) => {
        const counts = snap.val() || { "1": 0, "2": 0, "3": 0 };
        $("#c1").textContent = counts["1"] || 0;
        $("#c2").textContent = counts["2"] || 0;
        $("#c3").textContent = counts["3"] || 0;
      });
      // members
      onValue(ref(db, `rooms/${code}/members`), (snap) => {
        const byTeam = { "1": [], "2": [], "3": [] };
        const data = snap.val() || {};
        Object.values(data).forEach(m => {
          if (m && m.team && byTeam[m.team]) byTeam[m.team].push(m.name || "—");
        });
        ["1","2","3"].forEach(t => {
          const ul = document.getElementById(`t${t}`);
          ul.innerHTML = (byTeam[t].length ? byTeam[t] : []).map(n => `<li>${escapeHtml(n)}</li>`).join("");
        });
      });
    }

    function status(msg, isError=false) {
      statusEl.textContent = msg;
      statusEl.style.color = isError ? "crimson" : "inherit";
    }

    function escapeHtml(s) {
      return (s || "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]));
    }

    // Auto-attach listeners if URL had ?room=CODE
    if (roomParam) attachRoomListeners(roomParam.toUpperCase());
  </script>
</head>
<body>
  <div class="card">
    <h1>Quick Team Join</h1>
    <p class="muted">Make 3 teams instantly. Create a room, share the link, everyone clicks Join, and the app balances teams.</p>

    <h3>1) Create or enter a room</h3>
    <div class="row">
      <button id="create-room">Create new room</button>
      <input id="room" placeholder="Room code (e.g., ABC123)" />
      <button id="reset-room" title="Clear members & counts for this room">Reset</button>
    </div>
    <div id="share" style="margin-top:10px;"></div>

    <h3 style="margin-top:24px;">2) Join</h3>
    <div class="row">
      <input id="name" placeholder="Your nickname" />
      <button id="join-btn">Join → Auto-assign</button>
    </div>
    <div id="status" style="margin-top:10px;"></div>

    <h3 style="margin-top:24px;">Live teams</h3>
    <div class="teams" id="roster">
      <div class="team">
        <strong>Team 1</strong> — <span id="c1">0</span>
        <ul id="t1" style="margin:8px 0 0 18px;"></ul>
      </div>
      <div class="team">
        <strong>Team 2</strong> — <span id="c2">0</span>
        <ul id="t2" style="margin:8px 0 0 18px;"></ul>
      </div>
      <div class="team">
        <strong>Team 3</strong> — <span id="c3">0</span>
        <ul id="t3" style="margin:8px 0 0 18px;"></ul>
      </div>
    </div>
  </div>
</body>
</html>

